---
title: "Darwin Core Mapping"
subtitle: "KUL-Collections-bird-taxidermy-PAS "
author: "Dimitri Brosens"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

Load libraries:

```{r message = FALSE}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(readxl)         # To read Excel files
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
library(sp)             # coordinate transformation
library(leaflet)        # coordinate transformation
library(widgetframe)    # coordinate transformation
library(sf)             # coordinate transformation
library(lubridate)      # for the date
library(tidygeocoder) 
```

# Read source data

Create a data frame `input_data` from the source data:

The data was first processed in openrefine to enable georeferencing, also valid eventDate was created in refine
for script check: datasets/KUL-collections-taxidermi-birds-pas/src/dwc_mapping_grel.txt `github`
Once geocoded, run script from line 120 (first load libraries)


```{r}
input_interim <- read_csv(file = here::here("datasets", "kul-collections-taxidermi-birds-pas", "data", "interim", "KULeuven-ZoologyMuseum_refined.csv"))
```

Preview data:

```{r}
input_interim %>% head(n = 5)
```

# Process source data

## Tidy data

Clean data somewhat:

```{r}
input_interim %<>% remove_empty("rows")
```

```{r}
input_interim %>% head(n = 5)
```



# Georeference source data



## split column locality

not run, solution in openrefine


```{r include=FALSE}

input_interim %<>% separate(`dwc:locality`, sep = ',', remove = FALSE, into =  c('region','province','arrondissement','municipality'))

```


## geocoding

use osm geocoder service

```{r eval=FALSE, include=FALSE}
input_interim %<>% geocode(city = georeferenceBasis, country = `dwc:country`, method = 'osm', full_results = TRUE)

```
save geocoded file to save time while running script



Save to CSV:

```{r}
write_csv(input_interim, here::here("datasets", "kul-collections-taxidermi-birds-pas", "data", "interim", "occurrence_geo.csv"), na = "")
```

read geocoded file to start with


```{r}
input_interim_geo <- read_csv(file = here::here("datasets", "kul-collections-taxidermi-birds-pas", "data", "interim", "occurrence_geo.csv"))
```

# View geocoded file & check

```{r}
input_interim_geo %>% head(n = 5)
```



# Occurrence core

## Pre-processing

Create a dataframe occurrence data only 

```{r}
occurrence <- input_interim_geo
```






# Term mapping

Map the data to [Darwin Core Occurrence](http://rs.gbif.org/core/dwc_occurrence_2015-07-02.xml).

Start with record-level terms which contain metadata about the dataset (which is generally the same for all records).


# Record level


### type

```{r}
occurrence %<>% mutate(dwc_type = "PhysicalObject")
```

### language

```{r}
occurrence %<>% mutate(dwc_language = "en") # e.g. "en"
```

### license

```{r}
occurrence %<>% mutate(dwc_license = "http://creativecommons.org/publicdomain/zero/1.0/") # To be discussed
# e.g. "http://creativecommons.org/publicdomain/zero/1.0/"
```

### rightsHolder

```{r}
occurrence %<>% mutate(dwc_rightsHolder = "KU Leuven") # e.g. "INBO"
```
### accessRights

```{r}
occurrence %<>% mutate(dwc_accessRights = "http://www.inbo.be/en/norms-for-data-use") 
```

### datasetID

```{r}
occurrence %<>% mutate(dwc_datasetID = "insert doi") 
```

### institutionCode

```{r}
occurrence %<>% mutate(dwc_institutionCode = "KU Leuven") # e.g. "INBO"
```
### collectionCode

```{r}
occurrence %<>% mutate(dwc_collectionCode = `dwc:collectionCode`) # e.g. "INBO"
```



### datasetName

```{r}
occurrence %<>% mutate(datasetName = "KU Leuven - Birds from the Pas collection ***To be checked***") # e.g. "Checklist of non-native freshwater fishes in Flanders, Belgium"
```

The following terms contain information about the taxon:

### basisOfRecord

```{r}
occurrence %<>% mutate(dwc_basisOfRecord = "preservedSpecimen")
```

### informationWithHeld

### dataGeneralizations

# Occurrence

### occurrenceID

```{r}
occurrence %<>% mutate(occurrenceID = `dwc:catalogNumber` ) %>%
                mutate(occurrenceID = str_c("kul:col:", occurrenceID))
  
```

### recordedBy

```{r}
occurrence %<>% mutate(dwc_recordedBy = `dwc:recordedBy_collector`)
```

### individualCount

```{r}
occurrence %<>%  rename(dwc_individualCount = `dwc:individualCount`) 
                
```


### sex

```{r}
occurrence %<>%  rename(dwc_sex = `dwc:sex`) 
                
```


### lifeStage

```{r}
occurrence %<>%  rename(dwc_lifeStage = `dwc:lifeStage`) 
                
```

### behavior



## occurrenceStatus

```{r}
# to complete
```

## otherCatalogNumbers

```{r}
 occurrence %<>% mutate(dwc_otherCatalogNumbers = `dwc:otherCatalogNumbers`)
```

### occurrenceRemarks

```{r}
occurrence %<>% rename(dwc_occurrenceRemarks = "Frans Pas Collection")
```

# organism

```{r}
occurrence %<>% rename(dwc_previousIdentifications = `dwc:previousIdentifications`)

```

# organims remarks

```{r}
occurrence %<>% rename(dwc_organismRemarks = "pas collection stuffed birds")

```


### eventDate

eventDate already ok in source file (should be)

```{r}


#occurrence %<>% ymd(date)

occurrence %<>% mutate(eventDate = dmy(date))
# mutate(eventDate = as_date(ymd(date))) # , format = "%Y-%m-%d")) 

head(occurrence, n = 5)
```

# Location

```{r}
occurrence %<>%
  rename(decimalLongitude = X) %>%
  rename(decimalLatitude = Y) %>%
  mutate(geodeticDatum = "WGS84") %>%
  mutate(coordinateUncertaintyInMeters = "30") %>%
  mutate(verbatimCoordinateSystem = "Lambert coordinates") %>%
  mutate(verbatimSRS = "Belgian Datum 1972") %>%
  mutate(countryCode = "BE")  %>%            
  mutate(continent = "Europe")
```

```{r}
head(occurrence, n = 5)
occurrence %<>%
  mutate(verbatimLongitude = round(verbatimLongitude)) %>%
  mutate(verbatimLatitude = round(verbatimLatitude)) %>%
  mutate(decimalLongitude = round(decimalLongitude, digits = 5)) %>%
  mutate(decimalLatitude = round(decimalLatitude, digits = 5))
```

```{r}
occurrence %<>%   
   mutate(decimalLatitude = as.character(format(decimalLatitude, nsmall = 5))) %>%
   mutate(decimalLongitude = as.character(format(decimalLongitude, nsmall = 5)))
```

### continent

```{r}
occurrence %<>% mutate(dwc_continent = `dwc:continent` ) # e.g. "Belgium = BE"
```

### countryCode

```{r}
occurrence %<>% mutate(dwc_countryCode = `dwc:countryCode`) # e.g. "Belgium = BE"
```

### municipality

municipality already in source file

```{r}
occurrence %<>%
  mutate(dwc_municipality = municipality )
```

### verbatimcoordinates

### verbatimLatitude

### verbatimLongitude

### verbatimcoordinatesystem


### verbatimSRS


### decimalLatitude

### decimalLongitude

### geodeticDatum

### coordinateUncertaintyInMeters

### georeferenceRemarks

```{r}
occurrence %<>% mutate(dwc_georeferenceRemarks = georeferenceRemarks)
```


### identifiedBy

```{r}
occurrence %<>% mutate(identifiedBy = 'O-VL')
```

### scientificName 

```{r}
occurrence %<>% mutate(scientificName = case_when(kind_nl == 'Muskusrat' ~ "Ondatra zibethicus",
                                   kind_nl == 'Bruine rat' ~ "Rattus norvegicus"
                                       )
                                )
```

### kingdom

```{r}
occurrence %<>% mutate(kingdom = "Animalia")
```

### scientificNameAuthorship

```{r}
occurrence %<>% mutate(scientificNameAuthorship = case_when(kind_nl == 'Muskusrat' ~ "Linnaeus, 1766",
                                   kind_nl == 'Bruine rat' ~ "Berkenhout, 1759"
                                       )
                                )


```

### taxonRank

```{r}
occurrence %<>% mutate(taxonRank = "species")
```

### nomenclaturalCode

```{r}
occurrence %<>% mutate(nomenclaturalCode = "ICZN") # e.g. "ICZN"
```

### occurrenceStatus

```{r}
occurrence %<>% 
    ##select(individualCount) %>%
    mutate(occurrenceStatus = case_when(action_nl == 'Vastgesteld' & individualCount > 0 ~ "Present",
                                        action_nl == 'Vastgesteld' & individualCount == 0 ~ "Absent",
                                        action_nl == 'Gevangen' & individualCount > 0 ~ "Present",
                                        action_nl == 'Gevangen' & individualCount == 0 ~ "Absent",
                                        action_nl == 'Verwijderd' & individualCount > 0 ~ "Present",
                                        action_nl == 'Verwijderd' & individualCount == 0 ~ "Absent",
                                        action_nl == 'Geen vangst' & individualCount > 0 ~ "Present",
                                        action_nl == 'Geen vangst' & individualCount == 0 ~ "Absent",
                                        action_nl == 'Sporen' & individualCount > 0 ~ "Present",
                                        action_nl == 'Sporen' & individualCount == 0 ~ "Absent",
                                        action_nl == 'Hoeveelheid'& individualCount > 0 ~ "Present",
                                        action_nl == 'Hoeveelheid'& individualCount == 0 ~ "Absent",
                                        individualCount > 0 ~ "Present",
                                        individualCount == 0 ~ "Absent",
                                        is.na(action_nl) | is.na(individualCount) ~ "Absent"
                                                  
                                       ))
head(occurrence, n = 5)
```

```{r eval=FALSE, include=FALSE}

occurrence %<>%
        filter(eventDate > '2018-01-12' & occurrenceStatus == "Present" & scientificName == "Ondatra zibethicus") 
        
head (occurrence, n = 5 )

```






## Post-processing

```{r}
colnames(occurrence) <- str_remove(colnames(occurrence), "dwc_")
##occurrence %<>% select(-c(disposition, etiket_ref, collection, scientificName)) %<>% #remove collection columns
          ##  rename(scientificName = verbatimScientificName) 
```

```{r}
occurrence <- mutate_all(occurrence, as.character())
```

Define the order of the output columns

```{r}
col_order <- c( "type","language","license","rightsHolder","accessRights","datasetID"
               ,"institutionCode","datasetName","basisOfRecord","occurrenceID","recordedBy"
               ,"individualCount","organismQuantity","organismQuantityType","occurrenceStatus","occurrenceRemarks"
               ,"samplingProtocol","samplingEffort"
               ,"eventDate","continent","countryCode","municipality"
               ,"verbatimLatitude","verbatimLongitude","verbatimCoordinateSystem","verbatimSRS"
               ,"decimalLatitude","decimalLongitude","geodeticDatum","coordinateUncertaintyInMeters"
               ,"identifiedBy","scientificName","kingdom","scientificNameAuthorship","taxonRank","nomenclaturalCode"
               )
occurrence <- occurrence[, col_order]
```

Preview data:

```{r}
occurrence %>% head()
```

Save to CSV:

```{r}
write_csv(occurrence, here::here("datasets", "mica-oostvlaanderen-occurrences", "data", "processed", "occurrence.csv"), na = "")
```
